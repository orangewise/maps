name: Generate Map Posters

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  generate-maps:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.ref || github.ref }}
        repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}

    - name: Checkout maptoposter tool
      uses: actions/checkout@v4
      with:
        repository: orangewise/maptoposter
        path: maptoposter-tool

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v5

    - name: Install dependencies
      run: |
        cd maptoposter-tool
        uv pip install --system -r requirements.txt

    - name: Generate map posters
      run: |
        mkdir -p public/images

        # Copy existing posters to public/images
        if [ -d images ] && [ "$(ls -A images/*.png 2>/dev/null)" ]; then
          echo "Copying existing posters..."
          cp images/*.png public/images/
          echo "Copied $(ls images/*.png 2>/dev/null | wc -l) existing posters"
        fi

        # Install jq for JSON parsing
        sudo apt-get update && sudo apt-get install -y jq

        # Read cities.json and generate only new posters
        cd maptoposter-tool

        echo "Reading cities configuration..."
        cat ../cities.json | jq -c '.[]' | while read -r city_data; do
          city=$(echo "$city_data" | jq -r '.city')
          country=$(echo "$city_data" | jq -r '.country')
          radius=$(echo "$city_data" | jq -r '.radius')

          # Process each theme for this city
          echo "$city_data" | jq -r '.themes[]' | while read -r theme; do
            # Create filename (lowercase city with spaces replaced by hyphens)
            filename=$(echo "${city}-${theme}.png" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

            # Check if poster already exists
            if [ -f "../public/images/${filename}" ]; then
              echo "✓ Skipping ${city} (${theme}) - already exists"
            else
              echo "→ Generating ${city} (${theme}) with ${radius}m radius..."

              # Clean posters directory before generation
              rm -f posters/*.png

              # Generate the poster
              python create_map_poster.py --city "$city" --country "$country" --theme "$theme" --distance "$radius"

              # Check if poster was generated and copy it
              if ls posters/*.png 1> /dev/null 2>&1; then
                cp posters/*.png "../public/images/${filename}"
                echo "✓ Successfully generated ${filename}"
              else
                echo "⚠ Warning: Failed to generate ${filename}"
              fi
            fi
          done
        done

        echo ""
        echo "Generation complete. Final poster count: $(ls -1 ../public/images/*.png 2>/dev/null | wc -l)"

    - name: Optimize PNG images
      run: |
        # Install OptiPNG for lossless PNG compression
        sudo apt-get install -y optipng

        echo "Optimizing PNG images..."
        echo "Original sizes:"
        du -sh public/images/

        # Optimize all PNG images with OptiPNG (level 2 for good compression/speed balance)
        # -o2: optimization level (0-7, 2 is good balance)
        # -strip all: remove metadata to reduce size
        find public/images -name "*.png" -print0 | while IFS= read -r -d '' file; do
          original_size=$(stat -c%s "$file")
          echo "Optimizing $(basename "$file")..."
          optipng -o2 -strip all "$file"
          new_size=$(stat -c%s "$file")
          reduction=$((100 - (new_size * 100 / original_size)))
          echo "  Reduced by ${reduction}% ($(numfmt --to=iec $original_size) → $(numfmt --to=iec $new_size))"
        done

        echo ""
        echo "Optimized sizes:"
        du -sh public/images/
        echo "Optimization complete!"

    - name: Generate index.html
      run: |
        # Start HTML file
        cat > public/index.html << 'HTMLSTART'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Map Posters Gallery</title>
            <link rel="stylesheet" href="style.css">
        </head>
        <body>
            <header>
                <h1>Map Posters Gallery</h1>
                <p>Beautiful minimalist map posters generated using OpenStreetMap data</p>
            </header>

            <main class="gallery">
        HTMLSTART

        # Generate city sections dynamically
        cat cities.json | jq -c '.[]' | while read -r city_data; do
          city=$(echo "$city_data" | jq -r '.city')
          country=$(echo "$city_data" | jq -r '.country')
          radius=$(echo "$city_data" | jq -r '.radius')

          # Check if any posters exist for this city
          city_lower=$(echo "$city" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
          if ls public/images/${city_lower}-*.png 1> /dev/null 2>&1; then
            echo "                <div class=\"city-section\">" >> public/index.html
            echo "                    <h2>${city}, ${country}</h2>" >> public/index.html
            echo "                    <div class=\"poster-grid\">" >> public/index.html

            # Add each theme poster
            echo "$city_data" | jq -r '.themes[]' | while read -r theme; do
              filename="${city_lower}-${theme}.png"
              if [ -f "public/images/${filename}" ]; then
                # Format theme name for display
                theme_display=$(echo "$theme" | sed 's/_/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2));}1')

                # Add theme descriptions
                case "$theme" in
                  midnight_blue) desc="Calming blue palette perfect for modern interiors" ;;
                  ocean) desc="Deep ocean tones with crisp white streets, ${radius}m radius" ;;
                  sunset) desc="Warm sunset tones capturing the golden hour, ${radius}m radius" ;;
                  terracotta) desc="Classical earth tones with Mediterranean warmth, ${radius}m radius" ;;
                  contrast_zones) desc="Modern high contrast design, ${radius}m radius" ;;
                  neon_cyberpunk) desc="Vibrant neon colors with urban energy, ${radius}m radius" ;;
                  warm_beige) desc="Neutral warm palette with elegant simplicity, ${radius}m radius" ;;
                  pastel_dream) desc="Soft romantic pastel colors, ${radius}m radius" ;;
                  forest) desc="Natural forest greens with organic feel, ${radius}m radius" ;;
                  *) desc="Unique artistic interpretation, ${radius}m radius" ;;
                esac

                cat >> public/index.html << POSTER
                        <div class="poster-card">
                            <img src="images/${filename}" alt="${city} - ${theme_display}" loading="lazy">
                            <div class="poster-info">
                                <h3>${theme_display}</h3>
                                <p>${desc}</p>
                            </div>
                        </div>
        POSTER
              fi
            done

            echo "                    </div>" >> public/index.html
            echo "                </div>" >> public/index.html
          fi
        done

        # Close HTML file
        cat >> public/index.html << 'HTMLEND'
            </main>

            <footer>
                <p>Generated using <a href="https://github.com/orangewise/maptoposter">maptoposter</a></p>
                <p>Map data © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors</p>
            </footer>
        </body>
        </html>
        HTMLEND

    - name: Generate CSS
      run: |
        cat > public/style.css << 'EOF'
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
        }

        header {
            text-align: center;
            padding: 4rem 1.5rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        header h1 {
            font-size: 3rem;
            font-weight: 800;
            color: #1a202c;
            margin-bottom: 0.75rem;
            letter-spacing: -0.02em;
        }

        header p {
            font-size: 1.2rem;
            color: #4a5568;
            max-width: 600px;
            margin: 0 auto;
        }

        main {
            max-width: 1200px;
            margin: 3rem auto;
            padding: 0 1.5rem;
        }

        .city-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .city-section h2 {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 4px solid #667eea;
            letter-spacing: -0.01em;
        }

        .poster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2.5rem;
            margin-top: 2.5rem;
        }

        .poster-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
        }

        .poster-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 1;
            pointer-events: none;
        }

        .poster-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .poster-card:hover::before {
            opacity: 1;
        }

        .poster-card img {
            width: 100%;
            height: auto;
            min-height: 400px;
            display: block;
            object-fit: cover;
            border-bottom: 2px solid #e2e8f0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .poster-info {
            padding: 2rem;
            background: white;
            position: relative;
            z-index: 2;
        }

        .poster-info h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.75rem;
            letter-spacing: -0.01em;
        }

        .poster-info p {
            color: #4a5568;
            font-size: 1rem;
            line-height: 1.7;
        }

        footer {
            text-align: center;
            padding: 3rem 1.5rem;
            color: #4a5568;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            margin-top: 4rem;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }

        footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        footer a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        footer p {
            margin: 0.75rem 0;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            header {
                padding: 3rem 1.5rem;
            }

            header h1 {
                font-size: 2.25rem;
            }

            header p {
                font-size: 1.1rem;
            }

            .city-section {
                padding: 2rem 1.5rem;
                border-radius: 16px;
            }

            .city-section h2 {
                font-size: 1.875rem;
            }

            .poster-grid {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .poster-card img {
                min-height: 350px;
            }

            .poster-info {
                padding: 1.5rem;
            }

            footer {
                padding: 2rem 1.5rem;
            }
        }
        EOF

    - name: Upload generated images as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: map-posters
        path: public/images/
        retention-days: 90

    - name: Commit generated images to branch
      if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) || (github.event_name == 'push' && github.ref != 'refs/heads/main')
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # Create images directory if it doesn't exist
        mkdir -p images

        # Copy generated images to images directory
        cp public/images/*.png images/ || true

        # Check if there are any changes
        if [ -n "$(git status --porcelain images/)" ]; then
          git add images/
          git commit -m "Update generated map posters [skip ci]"
          git push
        else
          echo "No changes to commit"
        fi

    - name: Setup Pages
      if: github.ref == 'refs/heads/main'
      uses: actions/configure-pages@v4

    - name: Upload artifact
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'public'

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      id: deployment
      uses: actions/deploy-pages@v4
