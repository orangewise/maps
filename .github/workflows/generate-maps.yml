name: Generate Map Posters

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  generate-maps:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.ref || github.ref }}
        repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}

    - name: Checkout maptoposter tool
      uses: actions/checkout@v4
      with:
        repository: orangewise/maptoposter
        path: maptoposter-tool

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v5

    - name: Install dependencies
      run: |
        cd maptoposter-tool
        uv pip install --system -r requirements.txt

    - name: Generate map posters
      run: |
        mkdir -p public/images
        cd maptoposter-tool

        # Generate Haarlem map with midnight_blue theme (3km radius to focus on city center)
        python create_map_poster.py --city Haarlem --country Netherlands --theme midnight_blue --distance 3000
        cp posters/*.png ../public/images/haarlem-midnight_blue.png || true

        # Clean for next map
        rm -f posters/*.png

        # Generate with ocean theme (3km radius to focus on city center)
        python create_map_poster.py --city Haarlem --country Netherlands --theme ocean --distance 3000
        cp posters/*.png ../public/images/haarlem-ocean.png || true

    - name: Generate index.html
      run: |
        cat > public/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Map Posters Gallery</title>
            <link rel="stylesheet" href="style.css">
        </head>
        <body>
            <header>
                <h1>Map Posters Gallery</h1>
                <p>Beautiful minimalist map posters generated using OpenStreetMap data</p>
            </header>

            <main class="gallery">
                <div class="city-section">
                    <h2>Haarlem, Netherlands</h2>
                    <div class="poster-grid">
                        <div class="poster-card">
                            <img src="images/haarlem-midnight_blue.png" alt="Haarlem - Midnight Blue" loading="lazy">
                            <div class="poster-info">
                                <h3>Midnight Blue</h3>
                                <p>A calming blue palette perfect for modern interiors</p>
                            </div>
                        </div>
                        <div class="poster-card">
                            <img src="images/haarlem-ocean.png" alt="Haarlem - Ocean" loading="lazy">
                            <div class="poster-info">
                                <h3>Ocean</h3>
                                <p>Deep ocean tones with crisp white streets</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <footer>
                <p>Generated using <a href="https://github.com/orangewise/maptoposter">maptoposter</a></p>
                <p>Map data Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors</p>
            </footer>
        </body>
        </html>
        EOF

    - name: Generate CSS
      run: |
        cat > public/style.css << 'EOF'
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        header {
            text-align: center;
            padding: 3rem 1rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        header p {
            font-size: 1.1rem;
            color: #7f8c8d;
        }

        main {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .city-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .city-section h2 {
            font-size: 2rem;
            color: #34495e;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #3498db;
        }

        .poster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .poster-card {
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .poster-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .poster-card img {
            width: 100%;
            height: auto;
            display: block;
            border-bottom: 1px solid #e0e0e0;
        }

        .poster-info {
            padding: 1.5rem;
        }

        .poster-info h3 {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .poster-info p {
            color: #7f8c8d;
            font-size: 0.95rem;
        }

        footer {
            text-align: center;
            padding: 2rem 1rem;
            color: #7f8c8d;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            margin-top: 3rem;
        }

        footer a {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }

        footer a:hover {
            text-decoration: underline;
        }

        footer p {
            margin: 0.5rem 0;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            .poster-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .city-section {
                padding: 1.5rem;
            }
        }
        EOF

    - name: Upload generated images as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: map-posters
        path: public/images/
        retention-days: 90

    - name: Commit generated images to branch
      if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) || (github.event_name == 'push' && github.ref != 'refs/heads/main')
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # Create images directory if it doesn't exist
        mkdir -p images

        # Copy generated images to images directory
        cp public/images/*.png images/ || true

        # Check if there are any changes
        if [ -n "$(git status --porcelain images/)" ]; then
          git add images/
          git commit -m "Update generated map posters [skip ci]"
          git push
        else
          echo "No changes to commit"
        fi

    - name: Setup Pages
      if: github.ref == 'refs/heads/main'
      uses: actions/configure-pages@v4

    - name: Upload artifact
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'public'

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      id: deployment
      uses: actions/deploy-pages@v4
