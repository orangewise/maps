name: Generate Map Posters

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  generate-maps:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.ref || github.ref }}
        repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}

    - name: Checkout maptoposter tool
      uses: actions/checkout@v4
      with:
        repository: orangewise/maptoposter
        path: maptoposter-tool

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v5

    - name: Install dependencies
      run: |
        cd maptoposter-tool
        uv pip install --system -r requirements.txt

    - name: Generate map posters
      run: |
        mkdir -p public/images
        cd maptoposter-tool

        # Generate Haarlem map with midnight_blue theme (3km radius to focus on city center)
        python create_map_poster.py --city Haarlem --country Netherlands --theme midnight_blue --distance 3000
        cp posters/*.png ../public/images/haarlem-midnight_blue.png || true

        # Clean for next map
        rm -f posters/*.png

        # Generate with ocean theme (3km radius to focus on city center)
        python create_map_poster.py --city Haarlem --country Netherlands --theme ocean --distance 3000
        cp posters/*.png ../public/images/haarlem-ocean.png || true

    - name: Generate index.html
      run: |
        cat > public/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Map Posters Gallery</title>
            <link rel="stylesheet" href="style.css">
        </head>
        <body>
            <header>
                <h1>Map Posters Gallery</h1>
                <p>Beautiful minimalist map posters generated using OpenStreetMap data</p>
            </header>

            <main class="gallery">
                <div class="city-section">
                    <h2>Haarlem, Netherlands</h2>
                    <div class="poster-grid">
                        <div class="poster-card">
                            <img src="images/haarlem-midnight_blue.png" alt="Haarlem - Midnight Blue" loading="lazy">
                            <div class="poster-info">
                                <h3>Midnight Blue</h3>
                                <p>A calming blue palette perfect for modern interiors</p>
                            </div>
                        </div>
                        <div class="poster-card">
                            <img src="images/haarlem-ocean.png" alt="Haarlem - Ocean" loading="lazy">
                            <div class="poster-info">
                                <h3>Ocean</h3>
                                <p>Deep ocean tones with crisp white streets</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <footer>
                <p>Generated using <a href="https://github.com/orangewise/maptoposter">maptoposter</a></p>
                <p>Map data Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors</p>
            </footer>
        </body>
        </html>
        EOF

    - name: Generate CSS
      run: |
        cat > public/style.css << 'EOF'
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
        }

        header {
            text-align: center;
            padding: 4rem 1.5rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        header h1 {
            font-size: 3rem;
            font-weight: 800;
            color: #1a202c;
            margin-bottom: 0.75rem;
            letter-spacing: -0.02em;
        }

        header p {
            font-size: 1.2rem;
            color: #4a5568;
            max-width: 600px;
            margin: 0 auto;
        }

        main {
            max-width: 1200px;
            margin: 3rem auto;
            padding: 0 1.5rem;
        }

        .city-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .city-section h2 {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 4px solid #667eea;
            letter-spacing: -0.01em;
        }

        .poster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2.5rem;
            margin-top: 2.5rem;
        }

        .poster-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
        }

        .poster-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 1;
            pointer-events: none;
        }

        .poster-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .poster-card:hover::before {
            opacity: 1;
        }

        .poster-card img {
            width: 100%;
            height: auto;
            min-height: 400px;
            display: block;
            object-fit: cover;
            border-bottom: 2px solid #e2e8f0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .poster-info {
            padding: 2rem;
            background: white;
            position: relative;
            z-index: 2;
        }

        .poster-info h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.75rem;
            letter-spacing: -0.01em;
        }

        .poster-info p {
            color: #4a5568;
            font-size: 1rem;
            line-height: 1.7;
        }

        footer {
            text-align: center;
            padding: 3rem 1.5rem;
            color: #4a5568;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            margin-top: 4rem;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }

        footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        footer a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        footer p {
            margin: 0.75rem 0;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            header {
                padding: 3rem 1.5rem;
            }

            header h1 {
                font-size: 2.25rem;
            }

            header p {
                font-size: 1.1rem;
            }

            .city-section {
                padding: 2rem 1.5rem;
                border-radius: 16px;
            }

            .city-section h2 {
                font-size: 1.875rem;
            }

            .poster-grid {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .poster-card img {
                min-height: 350px;
            }

            .poster-info {
                padding: 1.5rem;
            }

            footer {
                padding: 2rem 1.5rem;
            }
        }
        EOF

    - name: Upload generated images as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: map-posters
        path: public/images/
        retention-days: 90

    - name: Commit generated images to branch
      if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) || (github.event_name == 'push' && github.ref != 'refs/heads/main')
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # Create images directory if it doesn't exist
        mkdir -p images

        # Copy generated images to images directory
        cp public/images/*.png images/ || true

        # Check if there are any changes
        if [ -n "$(git status --porcelain images/)" ]; then
          git add images/
          git commit -m "Update generated map posters [skip ci]"
          git push
        else
          echo "No changes to commit"
        fi

    - name: Setup Pages
      if: github.ref == 'refs/heads/main'
      uses: actions/configure-pages@v4

    - name: Upload artifact
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'public'

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      id: deployment
      uses: actions/deploy-pages@v4
